&ACCESS R
DEFDAT command_handler PUBLIC
    ; FOLD Custom enumerations
    GLOBAL CONST INT STATE_COUNT = 3
    GLOBAL ENUM DriverState INITIALIZED, INACTIVE, ACTIVE

    GLOBAL CONST INT EVENT_COUNT = 13
    GLOBAL ENUM EventType NONE, INVALID, STARTED, STOPPED, CANCELLED, RESET_OK, ERROR, CONNECTED, SWITCH_OK, DRIVES_TURNED_ON, DRIVES_TURNED_OFF, CYCLE_TIME_CHANGED, STATUS_UPDATED

    GLOBAL CONST INT COMMAND_COUNT = 9
    GLOBAL ENUM CommandType CMD_NONE, CMD_CON, CMD_START, CMD_RESET, CMD_CANCEL, CMD_CHANGE, CMD_INVALID, CMD_DRIVES_ON, CMD_DRIVES_OFF, CMD_CHANGE_CYCLE_TIME

    GLOBAL CONST INT CONTROL_MODE_COUNT = 3
    GLOBAL ENUM ControlMode INACTIVE, JOINT_POSITION, CART_POSITION
    ; ENDFOLD

    ; FOLD Custom structure types
    GLOBAL STRUC Command INT cmd_int, INT control_mode, INT cycle_time
    ; ENDFOLD

    ; FOLD State variables
    DECL DriverState current_driver_state = #INITIALIZED
    ; ENDFOLD

    ; FOLD Constants for mapping driver states to valid commands
    CONST INT INITIALIZED_VALID_COUNT = 5
    DECL CONST CommandType INIT_VALID_COMMANDS[16]
    INIT_VALID_COMMANDS[1] = #CMD_CON
    INIT_VALID_COMMANDS[2] = #CMD_CHANGE
    INIT_VALID_COMMANDS[3] = #CMD_DRIVES_ON
    INIT_VALID_COMMANDS[4] = #CMD_DRIVES_OFF
    INIT_VALID_COMMANDS[5] = #CMD_CHANGE_CYCLE_TIME

    CONST INT INACTIVE_VALID_COUNT = 6
    DECL CONST CommandType INACTIVE_VALID_COMMANDS[16]
    INACTIVE_VALID_COMMANDS[1] = #CMD_START
    INACTIVE_VALID_COMMANDS[2] = #CMD_CHANGE
    INACTIVE_VALID_COMMANDS[3] = #CMD_CANCEL
    INACTIVE_VALID_COMMANDS[4] = #CMD_DRIVES_ON
    INACTIVE_VALID_COMMANDS[5] = #CMD_DRIVES_OFF
    INACTIVE_VALID_COMMANDS[6] = #CMD_CHANGE_CYCLE_TIME

    CONST INT ACTIVE_VALID_COUNT = 2
    DECL CONST CommandType ACTIVE_VALID_COMMANDS[16]
    ACTIVE_VALID_COMMANDS[1] = #CMD_CANCEL
    ACTIVE_VALID_COMMANDS[2] = #CMD_RESET
    ; ENDFOLD
ENDDAT
