&ACCESS RV
&REL 11735
&PARAM DISKPATH = KRC:\R1\Program\ROS
DEFDAT command_handler PUBLIC
    ; FOLD Custom enumerations
    CONST INT STATE_COUNT = 3
    GLOBAL ENUM DriverState INITIALIZED, INACTIVE, ACTIVE

    GLOBAL CONST INT EVENT_COUNT = 12
    GLOBAL ENUM EventType NONE, INVALID, STARTED, STOPPED, CANCELLED, RESET_OK, ERROR, CONNECTED, SWITCH_OK, DRIVES_TURNED_ON, DRIVES_TURNED_OFF, CYCLE_TIME_CHANGED

    CONST INT CMD_COUNT = 9
    GLOBAL ENUM CMDType CMD_NONE, CMD_CON, CMD_START, CMD_RESET, CMD_CANCEL, CMD_CHANGE, CMD_INVALID, CMD_DRIVES_ON, CMD_DRIVES_OFF, CMD_CHANGE_CYCLE_TIME

    GLOBAL CONST INT CONTROL_MODE_COUNT = 3
    GLOBAL ENUM ControlMode INACTIVE, JOINT_POSITION, CART_POSITION
    ; ENDFOLD

    ; FOLD Custom structure types
    GLOBAL STRUC Command CHAR cmd_str[32], INT control_mode, INT cycle_time
    STRUC StringCommandPair CHAR cmd_string[32], CMDType cmd_type
    STRUC StringStatePair CHAR state_string[32], DriverState state
    ; ENDFOLD

    ; FOLD State variables
    DECL DriverState current_driver_state = #INITIALIZED
    ; ENDFOLD

    ; FOLD Constants for mapping strings to command types
    DECL CONST StringCommandPair STRING_COMMAND_PAIRS[9]
    STRING_COMMAND_PAIRS[1] = { cmd_string[] "CON", cmd_type #CMD_CON }
    STRING_COMMAND_PAIRS[2] = { cmd_string[] "START", cmd_type #CMD_START }
    STRING_COMMAND_PAIRS[3] = { cmd_string[] "RESET", cmd_type #CMD_RESET }
    STRING_COMMAND_PAIRS[4] = { cmd_string[] "CANCEL", cmd_type #CMD_CANCEL }
    STRING_COMMAND_PAIRS[5] = { cmd_string[] "CHANGE", cmd_type #CMD_CHANGE }
    STRING_COMMAND_PAIRS[6] = { cmd_string[] "NONE", cmd_type #CMD_NONE }
    STRING_COMMAND_PAIRS[7] = { cmd_string[] "DRIVES_ON", cmd_type #CMD_DRIVES_ON }
    STRING_COMMAND_PAIRS[8] = { cmd_string[] "DRIVES_OFF", cmd_type #CMD_DRIVES_OFF }
    STRING_COMMAND_PAIRS[9] = { cmd_string[] "CHANGE_CYCLE_TIME", cmd_type #CMD_CHANGE_CYCLE_TIME }
    ; ENDFOLD

    ; FOLD Constants for mapping strings to driver states
    DECL CONST StringStatePair STRING_STATE_PAIRS[3]
    STRING_STATE_PAIRS[1] = { state_string[] "INITIALIZED", state #INITIALIZED }
    STRING_STATE_PAIRS[2] = { state_string[] "INACTIVE", state #INACTIVE }
    STRING_STATE_PAIRS[3] = { state_string[] "ACTIVE", state #ACTIVE }
    ; ENDFOLD

    ; FOLD Constants for mapping driver states to valid commands
    CONST INT INITIALIZED_VALID_COUNT = 5
    DECL CONST CMDType INIT_VALID_COMMANDS[16]
    INIT_VALID_COMMANDS[1] = #CMD_CON
    INIT_VALID_COMMANDS[2] = #CMD_CHANGE
    INIT_VALID_COMMANDS[3] = #CMD_DRIVES_ON
    INIT_VALID_COMMANDS[4] = #CMD_DRIVES_OFF
    INIT_VALID_COMMANDS[5] = #CMD_CHANGE_CYCLE_TIME

    CONST INT INACTIVE_VALID_COUNT = 6
    DECL CONST CMDType INACTIVE_VALID_COMMANDS[16]
    INACTIVE_VALID_COMMANDS[1] = #CMD_START
    INACTIVE_VALID_COMMANDS[2] = #CMD_CHANGE
    INACTIVE_VALID_COMMANDS[3] = #CMD_CANCEL
    INACTIVE_VALID_COMMANDS[4] = #CMD_DRIVES_ON
    INACTIVE_VALID_COMMANDS[5] = #CMD_DRIVES_OFF
    INACTIVE_VALID_COMMANDS[6] = #CMD_CHANGE_CYCLE_TIME

    CONST INT ACTIVE_VALID_COUNT = 2
    DECL CONST CMDType ACTIVE_VALID_COMMANDS[16]
    ACTIVE_VALID_COMMANDS[1] = #CMD_CANCEL
    ACTIVE_VALID_COMMANDS[2] = #CMD_RESET
    ; ENDFOLD
ENDDAT
